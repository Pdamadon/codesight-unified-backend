!function(){"use strict";window.UnifiedCodeSightTracker||window.UNIFIED_CODESIGHT_LOADED?console.log("Unified CodeSight already loaded, skipping"):(window.UNIFIED_CODESIGHT_LOADED=!0,window.UnifiedCodeSightTracker=new class{constructor(){this.isTracking=!1,this.sessionId=null,this.startTime=0,this.events=[],this.screenshots=[],this.currentUrl=window.location.href,this.config={screenshotQuality:.8,maxScreenshots:200,maxEvents:1e3,privacyMode:!0,compressionEnabled:!0,burstModeEnabled:!0},this.pageStructure=null,this.lastInteractionTime=0,this.interactionSequence=0,this.currentTask=null,this.taskProgress={currentStep:0,completedSteps:[]},this.taskOverlay=null,this.sensitiveSelectors=['input[type="password"]','input[name*="password"]','input[name*="pwd"]','input[id*="password"]','input[placeholder*="password"]','input[name*="ssn"]','input[name*="social"]','input[name*="social-security"]','input[name*="social_security"]','input[name*="socialsecurity"]','input[id*="ssn"]','input[id*="social"]','input[name*="credit"]','input[name*="card"]','input[name*="cc"]','input[name*="cvv"]','input[name*="cvc"]','input[name*="security-code"]','input[name*="security_code"]','input[name*="securitycode"]','input[name*="expir"]','input[name*="exp-"]','input[name*="pin"]','input[id*="credit"]','input[id*="card"]','input[id*="cvv"]','input[id*="cvc"]','input[autocomplete*="cc"]','input[name*="bank"]','input[name*="routing"]','input[name*="account"]','input[name*="iban"]','input[name*="swift"]','input[id*="bank"]','input[id*="routing"]','input[id*="account"]','input[name*="first-name"]','input[name*="first_name"]','input[name*="firstname"]','input[name*="last-name"]','input[name*="last_name"]','input[name*="lastname"]','input[name*="full-name"]','input[name*="full_name"]','input[name*="fullname"]','input[name="name"]','input[id*="first-name"]','input[id*="first_name"]','input[id*="firstname"]','input[id*="last-name"]','input[id*="last_name"]','input[id*="lastname"]','input[id="name"]','input[name*="email"]','input[name*="phone"]','input[name*="mobile"]','input[name*="telephone"]','input[type="email"]','input[type="tel"]','input[id*="email"]','input[id*="phone"]','input[id*="mobile"]','input[name*="address"]','input[name*="street"]','input[name*="city"]','input[name*="state"]','input[name*="zip"]','input[name*="postal"]','input[name*="country"]','input[id*="address"]','input[id*="street"]','input[id*="city"]','input[id*="state"]','input[id*="zip"]','input[id*="postal"]','input[name*="birth"]','input[name*="dob"]','input[name*="age"]','input[id*="birth"]','input[id*="dob"]','input[id*="age"]','input[name*="license"]','input[name*="passport"]','input[name*="id-number"]','input[name*="id_number"]','input[name*="idnumber"]','input[id*="license"]','input[id*="passport"]','input[id*="id-number"]','input[type="hidden"]',"[data-sensitive]",".sensitive-data",'[autocomplete="new-password"]','[autocomplete="current-password"]','[autocomplete*="name"]','[autocomplete*="email"]','[autocomplete*="tel"]','[autocomplete*="address"]','[autocomplete*="postal-code"]','[autocomplete*="cc-"]'],this.initializeTracker()}initializeTracker(){chrome.runtime.onMessage.addListener((e,t,n)=>(this.handleMessage(e,t,n),!0)),this.setupNavigationHandling(),this.setupStatePreservation(),this.setupPeriodicStateSaving(),this.restoreState(),setTimeout(()=>{this.restoreTaskOverlay()},200),console.log("Unified CodeSight Tracker initialized v2.0")}async handleMessage(e,t,n){try{switch(e.action){case"START_TRACKING":await this.startTracking(e.sessionId,e.config,e.generatedTask),n({success:!0});break;case"STOP_TRACKING":n({success:!0,data:await this.stopTracking()});break;case"GET_STATUS":n(this.getStatus());break;case"GET_SESSION_DATA":n({success:!0,data:this.getSessionData()});break;case"UPDATE_CONFIG":this.updateConfig(e.config),n({success:!0});break;case"CAPTURE_SCREENSHOT":n({success:!0,screenshot:await this.captureScreenshot(e.trigger)});break;case"ping":n({success:!0,message:"Content script is working",tracker:!!window.UnifiedCodeSightTracker});break;default:n({success:!1,error:"Unknown action"})}}catch(e){console.error("Unified: Message handling error:",e),n({success:!1,error:e.message})}}async startTracking(e,t={},n=null){this.isTracking?console.log("Unified: Already tracking"):!0===await new Promise(e=>{chrome.storage.local.get(["userConsent"],t=>{e(t.userConsent)})})?(this.sessionId=e,this.startTime=Date.now(),this.isTracking=!0,this.events=[],this.screenshots=[],this.interactionSequence=0,this.config={...this.config,...t},n&&(this.currentTask=n,console.log("Unified: Using generated task:",n.title)),this.pageStructure=this.analyzePageStructure(),this.bindEventListeners(),this.showTrackingIndicator(),this.saveState(),await this.captureScreenshot("session_start"),this.startPeriodicValidation(),this.startBackendSession(),console.log("Unified: Tracking started for session:",e)):console.log("Unified: User consent not granted, cannot start tracking")}async stopTracking(){if(!this.isTracking)return console.log("Unified: Not currently tracking"),null;this.isTracking=!1,this.unbindEventListeners(),this.cleanupNavigationHandling(),this.cleanupStatePreservation(),this.stopPeriodicValidation(),this.hideTrackingIndicator(),this.hideTaskOverlay(),await this.captureScreenshot("session_end");const e=this.validateSessionData();console.log("Unified: Final validation score:",e.score);const t=await this.prepareSessionData();return await this.stopBackendSession(),this.stateSaveInterval&&(clearInterval(this.stateSaveInterval),this.stateSaveInterval=null),this.clearState(),console.log("Unified: Tracking stopped, captured",this.events.length,"events"),t}bindEventListeners(){this.boundClickHandler=this.handleClick.bind(this),document.addEventListener("click",this.boundClickHandler,!0),this.boundInputHandler=this.handleInput.bind(this),document.addEventListener("input",this.boundInputHandler,!0),this.boundFormHandler=this.handleFormSubmit.bind(this),document.addEventListener("submit",this.boundFormHandler,!0),this.boundScrollHandler=this.throttle(this.handleScroll.bind(this),200),document.addEventListener("scroll",this.boundScrollHandler,!0),this.boundFocusHandler=this.handleFocus.bind(this),document.addEventListener("focus",this.boundFocusHandler,!0),this.boundKeyHandler=this.handleKeyPress.bind(this),document.addEventListener("keydown",this.boundKeyHandler,!0)}unbindEventListeners(){this.boundClickHandler&&document.removeEventListener("click",this.boundClickHandler,!0),this.boundInputHandler&&document.removeEventListener("input",this.boundInputHandler,!0),this.boundFormHandler&&document.removeEventListener("submit",this.boundFormHandler,!0),this.boundScrollHandler&&document.removeEventListener("scroll",this.boundScrollHandler,!0),this.boundFocusHandler&&document.removeEventListener("focus",this.boundFocusHandler,!0),this.boundKeyHandler&&document.removeEventListener("keydown",this.boundKeyHandler,!0)}async handleClick(e){if(!this.isTracking)return;const t=e.target,n=Date.now(),i=t.getBoundingClientRect();if(i.width<3&&i.height<3)return;const s=this.captureScreenshot("click",n),a=this.generateEnhancedSelectors(t),r=this.captureEnhancedDOMContext(t),o=this.analyzeElementEnhanced(t),l=this.capturePageState(),c={type:"CLICK",timestamp:n,sessionTime:n-this.startTime,sequence:++this.interactionSequence,selectors:{primary:a.primary,alternatives:a.alternatives,xpath:a.xpath,cssPath:a.cssPath,selectorReliability:a.selectorReliability},primarySelector:a.primary,selectorAlternatives:a.alternatives,xpath:a.xpath,cssPath:a.cssPath,selectorReliability:a.selectorReliability,visual:{boundingBox:o.boundingBox,viewport:this.getViewportInfo(),isInViewport:o.isInViewport,percentVisible:o.percentVisible,screenshot:null},element:o,elementTag:o.tagName,elementText:o.text,elementValue:o.value,elementAttributes:o.attributes,boundingBox:o.boundingBox,isInViewport:o.isInViewport,percentVisible:o.percentVisible,context:{parentElements:r.parentElements,siblings:r.siblings,nearbyElements:r.nearbyElements,pageStructure:r.pageStructure},parentElements:r.parentElements,siblingElements:r.siblings,nearbyElements:r.nearbyElements,state:{before:l,after:null,changes:null},interaction:{coordinates:{clientX:e.clientX,clientY:e.clientY,pageX:e.pageX,pageY:e.pageY,offsetX:e.offsetX,offsetY:e.offsetY},modifiers:{ctrlKey:e.ctrlKey,shiftKey:e.shiftKey,altKey:e.altKey,metaKey:e.metaKey},timestamp:n,sessionTime:n-this.startTime,sequence:this.interactionSequence},metadata:{sessionId:this.sessionId,userId:"anon-user",timestamp:new Date(n).toISOString(),pageUrl:window.location.href,pageTitle:document.title,viewport:this.getViewportInfo()},pageContext:{domSnapshot:this.getPrunedDOMSnapshot(t),htmlHash:this.generatePageHash(),networkRequests:this.getRecentNetworkRequests()},elementDetails:{tag:t.tagName.toLowerCase(),text:this.getElementText(t),attributes:this.getElementAttributes(t),cssSelector:this.generateCSSSelector(t),xpath:this.generateXPath(t),boundingBox:this.getElementBoundingBox(t),computedStyle:this.getRelevantComputedStyle(t)},contextData:{parent:this.getParentElementInfo(t),ancestors:this.getAncestorChain(t),siblings:this.getSiblingElements(t),nearestClickable:this.findNearbyClickableElements(t,100)},overlays:this.detectActiveOverlays(),action:{type:"click",selector:a.primary,timestamp:new Date(n).toISOString()},coordinates:{clientX:e.clientX,clientY:e.clientY,pageX:e.pageX,pageY:e.pageY,offsetX:e.offsetX,offsetY:e.offsetY},modifiers:{ctrlKey:e.ctrlKey,shiftKey:e.shiftKey,altKey:e.altKey,metaKey:e.metaKey},stateBefore:l,url:window.location.href,pageTitle:document.title,viewport:this.getViewportInfo()};console.log("🎯 CLICK DATA COLLECTED:",{type:c.type,timestamp:new Date(c.timestamp).toISOString(),element:{tag:c.element?.tagName,text:c.element?.text?.substring(0,50)+"...",selector:c.selectors?.primary,isInteractive:c.element?.isInteractive,percentVisible:c.element?.percentVisible,attributeCount:Object.keys(c.element?.attributes||{}).length},selectors:{primary:c.selectors?.primary,alternativeCount:c.selectors?.alternatives?.length,topReliability:c.selectors?.selectorReliability?.[c.selectors.primary],xpath:c.selectors?.xpath?.substring(0,50)+"...",cssPath:c.selectors?.cssPath?.substring(0,50)+"..."},visual:{viewport:c.visual?.viewport,isInViewport:c.visual?.isInViewport,percentVisible:c.visual?.percentVisible,hasScreenshot:!!c.visual?.screenshot},interaction:{coordinates:!!c.interaction?.coordinates,modifiers:!!c.interaction?.modifiers,timestamp:c.interaction?.timestamp,sessionTime:c.interaction?.sessionTime,sequence:c.interaction?.sequence},state:{hasBefore:!!c.state?.before,hasAfter:!!c.state?.after,hasChanges:!!c.state?.changes},context:{parentCount:c.context?.parentElements?.length||0,siblingCount:c.context?.siblings?.length||0,nearbyElementCount:c.context?.nearbyElements?.length||0,hasPageStructure:!!c.context?.pageStructure},enhancedFields:{hasMetadata:!!c.metadata,hasPageContext:!!c.pageContext,hasElementDetails:!!c.elementDetails,hasContextData:!!c.contextData,hasOverlays:!!c.overlays,hasAction:!!c.action,overlayCount:c.overlays?.length||0}});const d=await s;d&&(c.screenshotId=d.id,c.visual.screenshot=d.id),setTimeout(()=>{const e=this.capturePageState(),t=this.detectStateChanges(l,e);c.state.after=e,c.state.changes=t,c.stateAfter=e,c.stateChanges=t,this.updateEvent(c),console.log("Enhanced: State changes detected:",{hasChanges:Object.keys(t).length>0,changeTypes:Object.keys(t),urlChanged:!!t.urlChanged,titleChanged:!!t.titleChanged,scrollChanged:!!t.scrollChanged,details:{urlChange:t.urlChanged?{from:t.urlChanged.from?.substring(0,50)+"...",to:t.urlChanged.to?.substring(0,50)+"...",type:t.urlChanged.type}:null,titleChange:t.titleChanged?{from:t.titleChanged.from?.substring(0,30)+"...",to:t.titleChanged.to?.substring(0,30)+"..."}:null,scrollChange:t.scrollChanged?{delta:t.scrollChanged.delta,direction:t.scrollChanged.direction}:null}})},1e3),this.captureEvent(c),this.lastInteractionTime=n}async handleInput(e){if(!this.isTracking)return;const t=e.target;if(this.isSensitiveInput(t))return void console.log("Unified: Skipping sensitive input");const n=Date.now(),i={type:"INPUT",timestamp:n,sessionTime:n-this.startTime,sequence:++this.interactionSequence,selectors:this.generateMultipleSelectors(t),element:this.analyzeElement(t),inputType:t.type||"text",inputName:t.name||"",placeholder:t.placeholder||"",valueLength:t.value?t.value.length:0,url:window.location.href,pageTitle:document.title};this.captureEvent(i)}async handleFormSubmit(e){if(!this.isTracking)return;const t=e.target,n=Date.now(),i=await this.captureScreenshot("form_submit",n),s={type:"FORM_SUBMIT",timestamp:n,sessionTime:n-this.startTime,sequence:++this.interactionSequence,selectors:this.generateMultipleSelectors(t),element:this.analyzeElement(t),formAction:t.action||"",formMethod:t.method||"GET",fieldCount:t.elements.length,screenshotId:i?.id,url:window.location.href,pageTitle:document.title};this.captureEvent(s)}handleScroll(e){this.isTracking}handleFocus(e){if(!this.isTracking)return;const t=e.target,n=Date.now(),i={type:"FOCUS",timestamp:n,sessionTime:n-this.startTime,sequence:++this.interactionSequence,selectors:this.generateMultipleSelectors(t),element:this.analyzeElement(t),url:window.location.href};this.captureEvent(i)}handleKeyPress(e){if(!this.isTracking)return;if(!["Enter","Tab","Escape","ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].includes(e.key)&&!e.ctrlKey&&!e.metaKey)return;const t=Date.now(),n={type:"KEY_PRESS",timestamp:t,sessionTime:t-this.startTime,sequence:++this.interactionSequence,key:e.key,code:e.code,modifiers:{ctrlKey:e.ctrlKey,shiftKey:e.shiftKey,altKey:e.altKey,metaKey:e.metaKey},url:window.location.href};this.captureEvent(n)}generateMultipleSelectors(e){const t={primary:null,alternatives:[],xpath:null,cssPath:null,reliability:{}};if(e.id&&"string"==typeof e.id&&e.id.trim()){const n=`#${e.id}`;t.primary=n,t.alternatives.push(n),t.reliability[n]=.95}const n=["data-testid","data-test","data-cy","data-qa","data-automation"];for(const i of n){const n=e.getAttribute(i);if(n){const e=`[${i}="${n}"]`;t.primary||(t.primary=e),t.alternatives.push(e),t.reliability[e]=.9}}const i=e.getAttribute("aria-label");if(i){const e=`[aria-label="${i}"]`;t.primary||(t.primary=e),t.alternatives.push(e),t.reliability[e]=.85}if(e.name){const n=`[name="${e.name}"]`;t.primary||(t.primary=n),t.alternatives.push(n),t.reliability[n]=.8}if(e.className&&"string"==typeof e.className){const n=e.className.split(" ").filter(e=>e.trim()&&!this.isUnstableClass(e));if(n.length>0){const e="."+n.join(".");t.primary||(t.primary=e),t.alternatives.push(e),t.reliability[e]=.6}}const s=this.buildTagSelector(e);return t.primary||(t.primary=s),t.alternatives.push(s),t.reliability[s]=.5,t.xpath=this.generateXPath(e),t.reliability[t.xpath]=.7,t.cssPath=this.generateCSSPath(e),t.reliability[t.cssPath]=.4,t.alternatives=[...new Set(t.alternatives)],t}isUnstableClass(e){return[/^(active|hover|focus|selected|current)$/i,/^(is-|has-)/i,/\d{4,}/,/^[a-f0-9]{8,}$/i,/^css-/i,/^sc-/i,/^emotion-/i].some(t=>t.test(e))}buildTagSelector(e){let t=e.tagName.toLowerCase();return e.type&&(t+=`[type="${e.type}"]`),e.getAttribute("role")&&(t+=`[role="${e.getAttribute("role")}"]`),t}generateXPath(e){if(e.id)return`//*[@id="${e.id}"]`;const t=[];for(;e&&e.nodeType===Node.ELEMENT_NODE;){let n=0,i=e.previousSibling;for(;i;)i.nodeType===Node.ELEMENT_NODE&&i.tagName===e.tagName&&n++,i=i.previousSibling;const s=e.tagName.toLowerCase(),a=n>0?`${s}[${n+1}]`:s;t.unshift(a),e=e.parentElement}return t.length?"/"+t.join("/"):null}generateCSSPath(e){const t=[];for(;e.parentNode;){if(e.id){t.unshift("#"+e.id);break}{let n=e.nodeName.toLowerCase();if(e.className&&"string"==typeof e.className){const t=e.className.split(" ").filter(e=>e.trim()&&!this.isUnstableClass(e));t.length>0&&(n+="."+t.join("."))}const i=Array.from(e.parentNode.children).filter(t=>t.nodeName===e.nodeName);i.length>1&&(n+=`:nth-of-type(${i.indexOf(e)+1})`),t.unshift(n),e=e.parentNode}}return t.join(" > ")}generateEnhancedSelectors(e){const t={primary:null,alternatives:[],xpath:null,cssPath:null,selectorReliability:{}};if(e.id&&"string"==typeof e.id&&e.id.trim()){const n=`#${CSS.escape(e.id)}`;t.primary=n,t.alternatives.push(n),t.selectorReliability[n]=this.testSelectorReliability(n)}const n=["data-testid","data-test","data-cy","data-qa","data-automation"];for(const i of n){const n=e.getAttribute(i);if(n&&n.trim()){const e=`[${i}="${CSS.escape(n)}"]`;t.primary||(t.primary=e),t.alternatives.push(e),t.selectorReliability[e]=this.testSelectorReliability(e)}}const i=e.getAttribute("aria-label");if(i&&i.trim()){const e=`[aria-label="${CSS.escape(i)}"]`;t.primary||(t.primary=e),t.alternatives.push(e),t.selectorReliability[e]=this.testSelectorReliability(e)}const s=e.getAttribute("name");if(s&&s.trim()){const e=`[name="${CSS.escape(s)}"]`;t.primary||(t.primary=e),t.alternatives.push(e),t.selectorReliability[e]=this.testSelectorReliability(e)}const a=e.getAttribute("role"),r=this.getElementText(e);if(a&&r&&r.length<50){const e=`[role="${a}"]:contains("${CSS.escape(r.substring(0,30))}")`;t.alternatives.push(e),t.selectorReliability[e]=.6}if(e.className&&"string"==typeof e.className){const n=e.className.split(" ").filter(e=>e.trim()&&!this.isUnstableClass(e)).slice(0,3);if(n.length>0){const e="."+n.map(e=>CSS.escape(e)).join(".");t.primary||(t.primary=e),t.alternatives.push(e),t.selectorReliability[e]=this.testSelectorReliability(e)}}const o=this.buildEnhancedTagSelector(e);return t.primary||(t.primary=o),t.alternatives.push(o),t.selectorReliability[o]=this.testSelectorReliability(o),t.xpath=this.generateXPath(e),t.selectorReliability[t.xpath]=.7,t.cssPath=this.generateFullCSSPath(e),t.selectorReliability[t.cssPath]=.4,t.alternatives=[...new Set(t.alternatives)].sort((e,n)=>(t.selectorReliability[n]||0)-(t.selectorReliability[e]||0)).slice(0,5),console.log("Enhanced selectors generated:",{primary:t.primary,alternativeCount:t.alternatives.length,topReliability:t.selectorReliability[t.primary],alternatives:t.alternatives.map(e=>({selector:e.substring(0,50)+"...",reliability:t.selectorReliability[e]}))}),t}buildEnhancedTagSelector(e){let t=e.tagName.toLowerCase();e.type&&(t+=`[type="${CSS.escape(e.type)}"]`);const n=e.getAttribute("role");if(n&&(t+=`[role="${CSS.escape(n)}"]`),"a"===e.tagName.toLowerCase()&&e.href){const n=e.getAttribute("href");n&&n.length<100&&(t+=`[href="${CSS.escape(n)}"]`)}if("input"===e.tagName.toLowerCase()&&e.value&&!this.isSensitiveInput(e)){const n=e.value.substring(0,20);t+=`[value="${CSS.escape(n)}"]`}return t}generateFullCSSPath(e){const t=[];let n=e;for(;n.parentNode&&n!==document.body;){if(n.id){t.unshift("#"+CSS.escape(n.id));break}{let e=n.nodeName.toLowerCase();if(n.className&&"string"==typeof n.className){const t=n.className.split(" ").filter(e=>e.trim()&&!this.isUnstableClass(e)).slice(0,2);t.length>0&&(e+="."+t.map(e=>CSS.escape(e)).join("."))}const i=Array.from(n.parentNode.children).filter(e=>e.nodeName===n.nodeName);i.length>1&&(e+=`:nth-of-type(${i.indexOf(n)+1})`),t.unshift(e),n=n.parentNode}}return t.join(" > ")}captureDOMContext(e){const t={parents:[],siblings:[],children:[],nearbyElements:[]};let n=e.parentElement,i=0;for(;n&&i<5;)t.parents.push({tagName:n.tagName.toLowerCase(),id:n.id||null,className:this.getStableClasses(n),role:n.getAttribute("role"),selector:this.generateMultipleSelectors(n).primary}),n=n.parentElement,i++;if(e.parentElement){const n=Array.from(e.parentElement.children),i=n.indexOf(e);for(let e=Math.max(0,i-2);e<=Math.min(n.length-1,i+2);e++)if(e!==i){const s=n[e];t.siblings.push({position:e<i?"before":"after",distance:Math.abs(e-i),tagName:s.tagName.toLowerCase(),text:this.getElementText(s),selector:this.generateMultipleSelectors(s).primary})}}return t.nearbyElements=this.findNearbyInteractiveElements(e),t}captureEnhancedDOMContext(e){const t={parentElements:[],siblings:[],nearbyElements:[],pageStructure:this.analyzePageStructure()};let n=e.parentElement,i=0;for(;n&&i<5;)t.parentElements.push({tagName:n.tagName.toLowerCase(),id:n.id||null,className:this.getStableClasses(n),role:n.getAttribute("role"),selector:this.generateEnhancedSelectors(n).primary,text:this.getElementTextEnhanced(n).substring(0,50),level:i+1}),n=n.parentElement,i++;if(e.parentElement){const n=Array.from(e.parentElement.children),i=n.indexOf(e);for(let e=Math.max(0,i-2);e<=Math.min(n.length-1,i+2);e++)if(e!==i){const s=n[e];t.siblings.push({position:e<i?"before":"after",distance:Math.abs(e-i),tagName:s.tagName.toLowerCase(),text:this.getElementTextEnhanced(s).substring(0,50),selector:this.generateEnhancedSelectors(s).primary,isInteractive:this.isInteractiveElement(s),boundingBox:this.getBoundingBox(s)})}}return t.nearbyElements=this.findNearbyClickableElementsEnhanced(e,100),t}findNearbyClickableElementsEnhanced(e,t=100){const n=[],i=e.getBoundingClientRect(),s={x:i.left+i.width/2,y:i.top+i.height/2};return document.querySelectorAll('a, button, input, select, textarea, [role="button"], [onclick], [data-clickable], [tabindex]:not([tabindex="-1"])').forEach(i=>{if(i===e)return;const a=i.getBoundingClientRect();if(0===a.width||0===a.height)return;const r={x:a.left+a.width/2,y:a.top+a.height/2},o=Math.sqrt(Math.pow(r.x-s.x,2)+Math.pow(r.y-s.y,2));o<=t&&n.push({selector:this.generateEnhancedSelectors(i).primary,tagName:i.tagName.toLowerCase(),text:this.getElementTextEnhanced(i).substring(0,30),distance:Math.round(o),direction:this.getRelativeDirection(s,r),isVisible:this.isElementVisible(i),isInteractive:this.isInteractiveElement(i)})}),n.sort((e,t)=>e.distance-t.distance).slice(0,10)}findNearbyInteractiveElements(e,t=150){const n=[],i=e.getBoundingClientRect(),s={x:i.left+i.width/2,y:i.top+i.height/2};return document.querySelectorAll('a, button, input, select, textarea, [role="button"], [onclick], [tabindex]').forEach(i=>{if(i===e)return;const a=i.getBoundingClientRect();if(0===a.width||0===a.height)return;const r={x:a.left+a.width/2,y:a.top+a.height/2},o=Math.sqrt(Math.pow(r.x-s.x,2)+Math.pow(r.y-s.y,2));o<=t&&n.push({selector:this.generateMultipleSelectors(i).primary,tagName:i.tagName.toLowerCase(),text:this.getElementText(i),distance:Math.round(o),direction:this.getRelativeDirection(s,r),isVisible:this.isElementVisible(i)})}),n.sort((e,t)=>e.distance-t.distance).slice(0,8)}analyzeElement(e){const t=window.getComputedStyle(e);return{tagName:e.tagName.toLowerCase(),text:this.getElementText(e),value:this.isSensitiveInput(e)?"[PROTECTED]":e.value||null,attributes:this.getRelevantAttributes(e),boundingBox:this.getBoundingBox(e),isVisible:this.isElementVisible(e),isInViewport:this.isElementInViewport(e),styles:{display:t.display,visibility:t.visibility,position:t.position,zIndex:t.zIndex,cursor:t.cursor,backgroundColor:t.backgroundColor,color:t.color},isInteractive:this.isInteractiveElement(e),role:e.getAttribute("role")||this.inferElementRole(e),tabIndex:e.tabIndex}}analyzeElementEnhanced(e){const t=window.getComputedStyle(e);return{tagName:e.tagName.toLowerCase(),text:this.getElementTextEnhanced(e),value:this.isSensitiveInput(e)?"[PROTECTED]":e.value||null,attributes:this.getAllElementAttributes(e),boundingBox:this.getBoundingBox(e),isVisible:this.isElementVisible(e),isInViewport:this.isElementInViewport(e),percentVisible:this.getElementVisibility(e),computedStyles:{display:t.display,visibility:t.visibility,position:t.position,zIndex:t.zIndex,width:t.width,height:t.height,padding:t.padding,margin:t.margin,backgroundColor:t.backgroundColor,color:t.color,fontSize:t.fontSize,cursor:t.cursor,pointerEvents:t.pointerEvents,opacity:t.opacity,transform:t.transform,transition:t.transition},isInteractive:this.isInteractiveElement(e),role:e.getAttribute("role")||this.inferElementRole(e),tabIndex:e.tabIndex,hasClickHandler:!(!e.onclick&&!e.getAttribute("onclick")),ariaLabel:e.getAttribute("aria-label"),title:e.title,alt:e.alt,placeholder:e.placeholder}}getElementTextEnhanced(e){if(!e)return"";const t=[];for(let n of e.childNodes)n.nodeType===Node.TEXT_NODE&&t.push(n.textContent.trim());let n=t.join(" ").trim();return n||(n=e.textContent?.trim()||""),n||(n=e.value||e.placeholder||e.alt||e.title||e.getAttribute("aria-label")||""),n.length>100?n.substring(0,100)+"...":n}getAllElementAttributes(e){const t={};for(let n of e.attributes)t[n.name]=n.value;return t}getElementVisibility(e){const t=e.getBoundingClientRect(),n=window.innerHeight,i=window.innerWidth,s=Math.min(t.bottom,n)-Math.max(t.top,0),a=Math.min(t.right,i)-Math.max(t.left,0),r=Math.max(0,s)*Math.max(0,a),o=t.height*t.width;return o>0?Math.round(r/o*100):0}getRelevantAttributes(e){const t={};return["id","class","name","type","role","aria-label","aria-describedby","data-testid","data-test","data-cy","data-qa","href","src","alt","title"].forEach(n=>{const i=e.getAttribute(n);null!==i&&(t[n]=i)}),t}isSensitiveInput(e){if(!e)return!1;if(e.type&&["password","hidden"].includes(e.type.toLowerCase()))return!0;if(this.sensitiveSelectors.some(t=>{try{return e.matches(t)}catch(e){return!1}}))return!0;const t=[/\b(first[-_\s]*name|last[-_\s]*name|full[-_\s]*name|given[-_\s]*name|surname|family[-_\s]*name)\b/i,/\b(email|e[-_\s]*mail|phone|mobile|telephone|fax)\b/i,/\b(address|street|city|state|province|zip|postal|country|region)\b/i,/\b(credit[-_\s]*card|debit[-_\s]*card|card[-_\s]*number|cvv|cvc|security[-_\s]*code|expiry|expiration|routing|account[-_\s]*number|iban|swift)\b/i,/\b(ssn|social[-_\s]*security|passport|license|id[-_\s]*number|tax[-_\s]*id)\b/i,/\b(birth[-_\s]*date|date[-_\s]*of[-_\s]*birth|dob|age|gender|nationality)\b/i,/\b(password|pin|secret|security[-_\s]*question|mother[-_\s]*maiden)\b/i],n=[e.name,e.id,e.className,e.placeholder,e.title,e.getAttribute("aria-label"),e.getAttribute("data-testid"),e.getAttribute("autocomplete")].filter(Boolean).join(" ").toLowerCase();if(t.some(e=>e.test(n)))return!0;const i=e.closest("label")||document.querySelector(`label[for="${e.id}"]`);if(i){const e=i.textContent.toLowerCase();if(t.some(t=>t.test(e)))return!0}if(e.value&&e.value.length>0){const t=/^\d{3}[-\s]?\d{2}[-\s]?\d{4}$/,n=/^[\+]?[1-9][\d]{0,2}[\s-]?\(?[\d]{3}\)?[\s-]?[\d]{3}[\s-]?[\d]{4}$/;if(/^\d{4}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{3,4}$/.test(e.value.replace(/\s/g,""))||t.test(e.value)||n.test(e.value))return!0}return!1}sanitizeData(e){if(!e||"object"!=typeof e)return e;const t=JSON.parse(JSON.stringify(e)),n=[{pattern:/\b\d{4}[\s-]?\d{4}[\s-]?\d{4}[\s-]?\d{3,4}\b/g,replacement:"[CREDIT_CARD_REDACTED]"},{pattern:/\b\d{3}[-\s]?\d{2}[-\s]?\d{4}\b/g,replacement:"[SSN_REDACTED]"},{pattern:/\b[\+]?[1-9][\d]{0,2}[\s-]?\(?[\d]{3}\)?[\s-]?[\d]{3}[\s-]?[\d]{4}\b/g,replacement:"[PHONE_REDACTED]"},{pattern:/\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Z|a-z]{2,}\b/g,replacement:"[EMAIL_REDACTED]"},{pattern:/\b\d{5}(-\d{4})?\b/g,replacement:"[ZIP_REDACTED]"},{pattern:/\b[A-Z][a-z]+ [A-Z][a-z]+\b/g,replacement:"[NAME_REDACTED]"}],i=e=>{if("string"==typeof e){let t=e;return n.forEach(({pattern:e,replacement:n})=>{t=t.replace(e,n)}),t}if(Array.isArray(e))return e.map(i);if(e&&"object"==typeof e){const t={};for(const[n,s]of Object.entries(e))this.isSensitiveKey(n)?t[n]="[PII_REDACTED]":t[n]=i(s);return t}return e};return i(t)}isSensitiveKey(e){return!(!e||"string"!=typeof e)&&[/password/i,/email/i,/phone/i,/address/i,/name/i,/credit/i,/card/i,/ssn/i,/social/i,/birth/i,/dob/i,/license/i,/passport/i].some(t=>t.test(e))}async captureScreenshot(e,t=Date.now()){if(!this.config.screenshotEnabled||this.screenshots.length>=this.config.maxScreenshots)return null;try{const n={trigger:e,timestamp:t,viewport:this.getViewportInfo(),url:window.location.href,quality:this.config.screenshotQuality},i=await chrome.runtime.sendMessage({action:"CAPTURE_SCREENSHOT",data:n});if(i&&i.success){const s={id:i.screenshotId,trigger:e,timestamp:t,...n};return this.screenshots.push(s),s}}catch(e){console.error("Unified: Screenshot capture failed:",e)}return null}analyzePageStructure(){return{hasNavigation:!!document.querySelector('nav, [role="navigation"]'),hasSearch:!!document.querySelector('input[type="search"], [role="searchbox"]'),hasFilters:document.querySelectorAll('[class*="filter"], [data-filter]').length>0,hasProductGrid:!!document.querySelector('[class*="grid"], [class*="product"], [data-products]'),hasShoppingCart:!!document.querySelector('[class*="cart"], [data-cart]'),hasPagination:!!document.querySelector('[class*="page"], [aria-label*="page"]'),totalElements:document.querySelectorAll("*").length,interactiveElements:document.querySelectorAll('button, a, input, select, textarea, [role="button"]').length,images:document.querySelectorAll("img").length,forms:document.querySelectorAll("form").length,pageType:this.detectPageType(),framework:this.detectFramework()}}detectPageType(){const e=window.location.href.toLowerCase(),t=document.title.toLowerCase(),n=document.body.textContent.toLowerCase();return e.includes("/cart")||t.includes("cart")||n.includes("shopping cart")?"cart":e.includes("/checkout")||t.includes("checkout")?"checkout":e.includes("/product")||e.includes("/item")||document.querySelector('[itemtype*="Product"]')?"product":e.includes("/search")||e.includes("?q=")||document.querySelector('[role="search"]')?"search":e.includes("/category")||e.includes("/browse")?"category":"other"}detectFramework(){const e=[];return(window.React||document.querySelector("[data-reactroot]"))&&e.push("React"),(window.Vue||document.querySelector("[data-v-]"))&&e.push("Vue"),(window.angular||document.querySelector("[ng-app], [data-ng-app]"))&&e.push("Angular"),(window.jQuery||window.$)&&e.push("jQuery"),e}setupNavigationHandling(){let e=window.location.href;const t=()=>{this.isTracking&&window.location.href!==e&&(this.handleNavigation(e,window.location.href),e=window.location.href)};this.navigationInterval=setInterval(t,1e3),this.popstateHandler=()=>{this.isTracking&&setTimeout(t,100)},window.addEventListener("popstate",this.popstateHandler)}cleanupNavigationHandling(){this.navigationInterval&&(clearInterval(this.navigationInterval),this.navigationInterval=null),this.popstateHandler&&(window.removeEventListener("popstate",this.popstateHandler),this.popstateHandler=null)}async handleNavigation(e,t){const n=Date.now();this.config.burstModeEnabled&&this.startBurstMode("navigation"),setTimeout(()=>{this.pageStructure=this.analyzePageStructure()},1e3);const i={type:"NAVIGATION",timestamp:n,sessionTime:n-this.startTime,sequence:++this.interactionSequence,fromUrl:e,toUrl:t,pageTitle:document.title,navigationType:this.detectNavigationType(e,t),pageStructure:this.pageStructure};this.captureEvent(i)}detectNavigationType(e,t){return e===t?"refresh":t.includes("#")?"hash_change":new URL(e).pathname===new URL(t).pathname?"query_change":"page_change"}startBurstMode(e){const t="navigation"===e?3:5;for(let n=0;n<t;n++)setTimeout(()=>{this.isTracking&&this.captureScreenshot(`burst_${e}_${n+1}`)},500*n)}captureEvent(e){this.events.length>=this.config.maxEvents&&(console.warn("Unified: Max events reached, dropping oldest"),this.events.shift());const t=this.sanitizeData(e);this.events.push({...t,id:this.generateId(),sessionId:this.sessionId}),this.sendEventToBackground(e),this.saveState(),this.events.length>this.config.maxEvents/2&&this.performEventCleanup()}performEventCleanup(){const e=Date.now();this.events=this.events.filter(t=>e-t.timestamp<18e5),this.events.length>this.config.maxEvents&&(this.events=this.events.slice(-this.config.maxEvents))}updateEvent(e){const t=this.events.findIndex(t=>t.id===e.id);-1!==t&&(this.events[t]={...this.events[t],...e},this.saveState())}async sendEventToBackground(e){try{console.log("Unified: Sending event to background:",e.type);const t=await chrome.runtime.sendMessage({action:"SEND_DATA",data:e});console.log("Unified: Background response:",t)}catch(t){console.error("Unified: Failed to send event to background:",t),t.message.includes("Could not establish connection")&&(console.log("Unified: Background script disconnected, attempting to reconnect..."),setTimeout(()=>{this.sendEventToBackground(e)},1e3))}}async startBackendSession(){try{console.log("Unified: Starting backend session:",this.sessionId);const e=await chrome.runtime.sendMessage({action:"START_BACKEND_SESSION",sessionId:this.sessionId,generatedTask:this.currentTask,config:{type:"AUTOMATED",url:window.location.href,userAgent:navigator.userAgent,timestamp:Date.now()}});console.log("Unified: Backend session started:",e)}catch(e){console.error("Unified: Failed to start backend session:",e)}}async stopBackendSession(){try{console.log("Unified: Stopping backend session:",this.sessionId);const e=await chrome.runtime.sendMessage({action:"STOP_BACKEND_SESSION",sessionId:this.sessionId});console.log("Unified: Backend session stopped:",e)}catch(e){console.error("Unified: Failed to stop backend session:",e)}}capturePageState(){return{url:window.location.href,title:document.title,scrollPosition:{x:window.scrollX,y:window.scrollY},viewport:this.getViewportInfo(),activeElement:this.getActiveElementInfo(),visibleElements:this.getVisibleElementsCount(),timestamp:Date.now()}}detectStateChanges(e,t){const n={};e.url!==t.url&&(n.urlChanged={from:e.url,to:t.url,type:this.detectNavigationType(e.url,t.url)},n.newUrl=t.url),e.title!==t.title&&(n.titleChanged={from:e.title,to:t.title},n.newTitle=t.title);const i={x:Math.abs(t.scrollPosition.x-e.scrollPosition.x),y:Math.abs(t.scrollPosition.y-e.scrollPosition.y)};return(i.x>10||i.y>10)&&(n.scrollChanged={from:e.scrollPosition.y,to:t.scrollPosition.y,delta:t.scrollPosition.y-e.scrollPosition.y,direction:t.scrollPosition.y>e.scrollPosition.y?"down":"up"},n.scrollDiff=i),e.visibleElements!==t.visibleElements&&(n.elementsChanged=!0,n.elementDiff=t.visibleElements-e.visibleElements),n}getActiveElementInfo(){const e=document.activeElement;return e&&e!==document.body?{tagName:e.tagName.toLowerCase(),id:e.id||null,className:e.className||null,selector:this.generateMultipleSelectors(e).primary}:null}getVisibleElementsCount(){const e=document.querySelectorAll("*");let t=0;for(const n of e)this.isElementVisible(n)&&t++;return t}getViewportInfo(){return{width:window.innerWidth,height:window.innerHeight,scrollX:window.scrollX,scrollY:window.scrollY,devicePixelRatio:window.devicePixelRatio||1}}getBoundingBox(e){const t=e.getBoundingClientRect();return{x:t.x,y:t.y,width:t.width,height:t.height,top:t.top,right:t.right,bottom:t.bottom,left:t.left}}isElementVisible(e){if(!e)return!1;const t=e.getBoundingClientRect();if(0===t.width||0===t.height)return!1;const n=window.getComputedStyle(e);return"none"!==n.display&&"hidden"!==n.visibility&&"0"!==n.opacity}isElementInViewport(e){const t=e.getBoundingClientRect();return t.top>=0&&t.left>=0&&t.bottom<=window.innerHeight&&t.right<=window.innerWidth}isInteractiveElement(e){if(["a","button","input","select","textarea"].includes(e.tagName.toLowerCase()))return!0;const t=e.getAttribute("role");return!(!t||!["button","link","menuitem","tab"].includes(t.toLowerCase()))||!(!e.hasAttribute("onclick")&&!e.hasAttribute("tabindex"))}inferElementRole(e){return{a:"link",button:"button",input:"textbox",select:"combobox",textarea:"textbox",img:"image",nav:"navigation",main:"main",header:"banner",footer:"contentinfo",aside:"complementary"}[e.tagName.toLowerCase()]||"generic"}getElementText(e){return e?"input"===e.tagName.toLowerCase()?e.placeholder||e.value||"":(e.textContent||e.innerText||"").trim().substring(0,200):""}getStableClasses(e){return e.className&&"string"==typeof e.className?e.className.split(" ").filter(e=>e.trim()&&!this.isUnstableClass(e)).join(" "):""}getRelativeDirection(e,t){const n=t.x-e.x,i=t.y-e.y;return Math.abs(n)>Math.abs(i)?n>0?"right":"left":i>0?"below":"above"}saveState(){if(!this.sessionId)return;const e={sessionId:this.sessionId,isTracking:this.isTracking,startTime:this.startTime,eventCount:this.events.length,screenshotCount:this.screenshots.length,currentTask:this.currentTask,taskProgress:this.taskProgress,lastSaved:Date.now()};try{localStorage.setItem("unified_codesight_state",JSON.stringify(e))}catch(e){console.error("Unified: Failed to save state:",e)}}restoreState(){try{const e=localStorage.getItem("unified_codesight_state");if(!e)return;const t=JSON.parse(e);Date.now()-t.lastSaved<36e5&&(this.sessionId=t.sessionId,this.isTracking=t.isTracking,this.startTime=t.startTime,this.currentTask=t.currentTask,this.taskProgress=t.taskProgress||{currentStep:0,completedSteps:[]},this.events||(this.events=[]),this.screenshots||(this.screenshots=[]),this.restoredEventCount=t.eventCount||0,this.restoredScreenshotCount=t.screenshotCount||0,this.isTracking&&(console.log("Unified: Restored tracking state for session:",this.sessionId),this.bindEventListeners(),this.showTrackingIndicator(),this.sendEventToBackground({type:"navigation_restored",sessionId:this.sessionId,url:window.location.href,timestamp:Date.now()}),this.startPeriodicValidation()))}catch(e){console.error("Unified: Failed to restore state:",e)}}clearState(){try{localStorage.removeItem("unified_codesight_state")}catch(e){console.error("Unified: Failed to clear state:",e)}}setupPeriodicStateSaving(){this.stateSaveInterval=setInterval(()=>{this.isTracking&&this.saveState()},2e3)}async prepareSessionData(){return{sessionId:this.sessionId,startTime:this.startTime,endTime:Date.now(),duration:Date.now()-this.startTime,events:this.events,eventCount:this.events.length,screenshots:this.screenshots,screenshotCount:this.screenshots.length,initialUrl:this.currentUrl,finalUrl:window.location.href,pageStructure:this.pageStructure,userAgent:navigator.userAgent,viewport:this.getViewportInfo(),qualityScore:this.calculateQualityScore(),completeness:this.calculateCompleteness()}}calculateQualityScore(){let e=0;this.events.length>0&&(e+=20);const t=new Set(this.events.map(e=>e.type));e+=Math.min(10*t.size,30),this.screenshots.length>0&&(e+=20);const n=(Date.now()-this.startTime)/6e4;n>=.5&&n<=5?e+=20:n>5&&(e+=10);const i=this.events.filter(e=>"CLICK"===e.type).length,s=this.events.filter(e=>"INPUT"===e.type).length;return i>0&&s>0&&(e+=10),this.events.filter(e=>"NAVIGATION"===e.type).length>0&&(e+=10),Math.min(e,100)}calculateCompleteness(){let e=0;return this.events.length>0&&(e+=25),this.screenshots.length>0&&(e+=25),this.pageStructure&&(e+=25),this.events.some(e=>"CLICK"===e.type)&&(e+=12.5),this.events.some(e=>"NAVIGATION"===e.type)&&(e+=12.5),Math.min(e,100)}validateSessionData(){const e={isValid:!0,score:100,errors:[],warnings:[],suggestions:[],metrics:{}};return this.validateBasicSessionData(e),this.validateEvents(e),this.validateScreenshots(e),this.validateInteractionPatterns(e),this.validateDataCompleteness(e),e.score=Math.max(0,e.score-10*e.errors.length-5*e.warnings.length),e.isValid=e.score>=60&&0===e.errors.length,e}validateBasicSessionData(e){this.sessionId||(e.errors.push("Missing session ID"),e.score-=20);const t=Date.now()-this.startTime;t<1e4?(e.warnings.push("Session duration is very short (< 10s)"),e.suggestions.push("Consider longer interaction sessions for better training data")):t>18e5&&(e.warnings.push("Session duration is very long (> 30min)"),e.suggestions.push("Consider breaking long sessions into smaller chunks")),e.metrics.sessionDuration=t,e.metrics.sessionDurationMinutes=Math.round(t/6e4)}validateEvents(e){if(0===this.events.length)return e.errors.push("No interaction events captured"),void(e.score-=30);let t=0,n=0;const i=new Set,s=[],a=[];this.events.forEach((r,o)=>{let l=!0;if(r.type?i.add(r.type):(e.errors.push(`Event ${o}: Missing event type`),l=!1),r.timestamp||(e.errors.push(`Event ${o}: Missing timestamp`),a.push(o),l=!1),"CLICK"===r.type){if(r.selectors&&r.selectors.primary){const t=this.testSelectorReliability(r.selectors.primary);t<.5&&e.warnings.push(`Click event ${o}: Low selector reliability (${Math.round(100*t)}%)`)}else e.warnings.push(`Click event ${o}: Missing primary selector`),s.push(o);r.coordinates||e.warnings.push(`Click event ${o}: Missing click coordinates`)}r.url||e.warnings.push(`Event ${o}: Missing URL`),l?t++:n++}),i.size<2&&(e.warnings.push("Low event type diversity - consider capturing more interaction types"),e.suggestions.push("Try to include clicks, inputs, navigation, and scrolling")),this.detectSuspiciousPatterns(e),e.metrics.totalEvents=this.events.length,e.metrics.validEvents=t,e.metrics.invalidEvents=n,e.metrics.eventTypes=Array.from(i),e.metrics.eventTypeCount=i.size,e.metrics.missingSelectors=s.length,e.metrics.missingTimestamps=a.length}validateScreenshots(e){if(0===this.screenshots.length)e.warnings.push("No screenshots captured"),e.suggestions.push("Screenshots provide valuable visual context for training"),e.score-=10;else{let t=0,n=0;this.screenshots.forEach((i,s)=>{i.dataUrl&&i.dataUrl.startsWith("data:image/")?t++:(e.errors.push(`Screenshot ${s}: Invalid or missing image data`),n++),i.timestamp||e.warnings.push(`Screenshot ${s}: Missing timestamp`),i.trigger||e.warnings.push(`Screenshot ${s}: Missing trigger information`)});const i=Date.now()-this.startTime,s=this.screenshots.length/(i/1e3);s>2?e.warnings.push("Very high screenshot capture rate - may impact performance"):s<.1&&e.warnings.push("Low screenshot capture rate - may miss important visual changes"),e.metrics.totalScreenshots=this.screenshots.length,e.metrics.validScreenshots=t,e.metrics.corruptedScreenshots=n,e.metrics.screenshotRate=s}}validateInteractionPatterns(e){const t=this.events.filter(e=>"CLICK"===e.type),n=this.events.filter(e=>"INPUT"===e.type),i=this.events.filter(e=>"NAVIGATION"===e.type),s=this.events.filter(e=>"SCROLL"===e.type);if(0===t.length&&(e.warnings.push("No click interactions captured"),e.suggestions.push("Click interactions are essential for shopping behavior training")),t.length>1){const n=[];for(let e=1;e<t.length;e++)n.push(t[e].timestamp-t[e-1].timestamp);const i=n.reduce((e,t)=>e+t,0)/n.length,s=Math.min(...n);s<100&&e.warnings.push("Suspiciously fast clicking detected - may indicate automated behavior"),i<500&&e.warnings.push("Very rapid clicking pattern - may not represent natural human behavior"),e.metrics.averageClickInterval=i,e.metrics.minimumClickInterval=s}this.validateShoppingPatterns(e),e.metrics.clickCount=t.length,e.metrics.inputCount=n.length,e.metrics.navigationCount=i.length,e.metrics.scrollCount=s.length}validateShoppingPatterns(e){const t=this.events.map(e=>e.url).filter(Boolean),n=new Set(t),i=["product","item","cart","checkout","buy","shop","category","search"],s=t.some(e=>i.some(t=>e.toLowerCase().includes(t)));s||(e.warnings.push("No shopping-related URLs detected"),e.suggestions.push("Ensure interactions occur on e-commerce pages for relevant training data"));const a=this.events.filter(e=>e.url&&e.url.toLowerCase().includes("product")).length,r=this.events.filter(e=>e.elementText&&e.elementText.toLowerCase().includes("cart")).length;0===a&&e.warnings.push("No product page interactions detected"),0===r&&e.suggestions.push("Consider including cart interactions for complete shopping behavior"),e.metrics.uniqueUrls=n.size,e.metrics.productViews=a,e.metrics.cartActions=r,e.metrics.hasShoppingUrls=s}validateDataCompleteness(e){const t=this.calculateCompleteness();t<50?(e.errors.push("Data completeness is too low for quality training"),e.score-=20):t<75&&(e.warnings.push("Data completeness could be improved"),e.suggestions.push("Try to capture more diverse interactions and screenshots"));const n=[];0===this.events.length&&n.push("interaction events"),0===this.screenshots.length&&n.push("screenshots"),this.pageStructure||n.push("page structure analysis"),n.length>0&&e.errors.push(`Missing critical data: ${n.join(", ")}`),e.metrics.completeness=t,e.metrics.criticalMissing=n}detectSuspiciousPatterns(e){const t=this.events.filter(e=>"CLICK"===e.type);if(t.length>0){const n=t.map(e=>`${e.coordinates?.clientX},${e.coordinates?.clientY}`),i=new Set(n);n.length>3&&1===i.size&&e.warnings.push("Identical click coordinates detected - may indicate automated behavior");const s=[];for(let e=1;e<t.length;e++)s.push(t[e].timestamp-t[e-1].timestamp);s.length>2&&this.calculateVariance(s)<100&&e.warnings.push("Suspiciously consistent timing pattern detected")}const n=this.events.some(e=>"SCROLL"===e.type);this.events.some(e=>e.coordinates),!n&&this.events.length>5&&e.suggestions.push("Consider including scrolling behavior for more natural interaction patterns")}testSelectorReliability(e){try{const t=document.querySelectorAll(e);return 0===t.length?0:1===t.length?1:t.length<=3?.8:t.length<=10?.6:.3}catch(e){return 0}}calculateVariance(e){const t=e.reduce((e,t)=>e+t,0)/e.length;return e.map(e=>Math.pow(e-t,2)).reduce((e,t)=>e+t,0)/e.length}showValidationFeedback(e){const t=document.getElementById("unified-validation-feedback");if(t&&t.remove(),0===e.errors.length&&0===e.warnings.length)return;const n=document.createElement("div");n.id="unified-validation-feedback",n.innerHTML=`\n        <div style="\n          position: fixed;\n          top: 50px;\n          right: 10px;\n          background: ${e.errors.length>0?"#f44336":"#ff9800"};\n          color: white;\n          padding: 12px;\n          border-radius: 4px;\n          font-family: Arial, sans-serif;\n          font-size: 12px;\n          z-index: 999998;\n          box-shadow: 0 2px 4px rgba(0,0,0,0.2);\n          max-width: 300px;\n          cursor: pointer;\n        " onclick="this.style.display='none'">\n          <div style="font-weight: bold; margin-bottom: 8px;">\n            Data Quality: ${e.score}/100\n          </div>\n          ${e.errors.length>0?`\n            <div style="margin-bottom: 4px;">\n              <strong>Errors:</strong> ${e.errors.length}\n            </div>\n          `:""}\n          ${e.warnings.length>0?`\n            <div style="margin-bottom: 4px;">\n              <strong>Warnings:</strong> ${e.warnings.length}\n            </div>\n          `:""}\n          <div style="font-size: 10px; opacity: 0.8;">\n            Click to dismiss\n          </div>\n        </div>\n      `,document.body.appendChild(n),setTimeout(()=>{n.parentNode&&n.remove()},1e4)}startPeriodicValidation(){this.validationInterval&&clearInterval(this.validationInterval),this.validationInterval=setInterval(()=>{if(this.isTracking&&this.events.length>0){const e=this.validateSessionData();(e.errors.length>0||e.warnings.length>2)&&this.showValidationFeedback(e),chrome.runtime.sendMessage({action:"VALIDATION_UPDATE",sessionId:this.sessionId,validation:{score:e.score,isValid:e.isValid,errorCount:e.errors.length,warningCount:e.warnings.length,metrics:e.metrics}}).catch(()=>{})}},3e4)}stopPeriodicValidation(){this.validationInterval&&(clearInterval(this.validationInterval),this.validationInterval=null)}showTrackingIndicator(){if(document.getElementById("unified-tracking-indicator"))return;const e=document.createElement("div");e.id="unified-tracking-indicator",e.innerHTML='\n        <div style="\n          position: fixed;\n          top: 10px;\n          right: 10px;\n          background: #4CAF50;\n          color: white;\n          padding: 8px 12px;\n          border-radius: 4px;\n          font-family: Arial, sans-serif;\n          font-size: 12px;\n          z-index: 999999;\n          box-shadow: 0 2px 4px rgba(0,0,0,0.2);\n        ">\n          🔴 CodeSight Recording\n        </div>\n      ',document.body.appendChild(e)}hideTrackingIndicator(){const e=document.getElementById("unified-tracking-indicator");e&&e.remove()}async fetchAndDisplayTask(){console.log("Unified: fetchAndDisplayTask() called");try{console.log("Unified: Fetching task for session:",this.sessionId);const e=await chrome.runtime.sendMessage({action:"FETCH_TASK",sessionId:this.sessionId,difficulty:"beginner"});if(!(e&&e.success&&e.task))throw new Error("Failed to fetch task: "+(e?.error||"Unknown error"));this.currentTask=e.task,console.log("Unified: Task loaded:",this.currentTask.title)}catch(e){console.error("Unified: Failed to fetch task:",e),this.currentTask={title:"Explore this website",description:"Browse around and interact with different elements to help train our AI system",website:window.location.href,difficulty:"BEGINNER"}}}showTaskOverlay(){if(document.getElementById("unified-task-overlay"))return;if(!this.currentTask)return;const e=document.createElement("div");e.id="unified-task-overlay";const t=this.currentTask.website||"the target website",n=t.includes("://")?new URL(t).hostname:t;e.innerHTML=`\n        <div style="\n          position: fixed;\n          top: 50px;\n          right: 10px;\n          width: 320px;\n          background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);\n          color: white;\n          padding: 18px;\n          border-radius: 12px;\n          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;\n          font-size: 14px;\n          z-index: 999998;\n          box-shadow: 0 4px 20px rgba(0,0,0,0.25);\n          border: 1px solid rgba(255,255,255,0.2);\n        ">\n          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 14px;">\n            <h4 style="margin: 0; font-size: 18px; color: #fff; display: flex; align-items: center;">\n              🎯 <span style="margin-left: 8px;">Your Task</span>\n            </h4>\n            <button onclick="document.getElementById('unified-task-overlay').style.display='none'" \n                    style="background: none; border: none; color: white; font-size: 20px; cursor: pointer; opacity: 0.8; padding: 4px;">×</button>\n          </div>\n          \n          <div style="margin-bottom: 16px;">\n            <div style="font-weight: 600; margin-bottom: 6px; font-size: 15px;">${this.currentTask.title}</div>\n            <div style="font-size: 13px; opacity: 0.9; line-height: 1.4;">${this.currentTask.description}</div>\n          </div>\n          \n          <div style="\n            background: rgba(255,255,255,0.15);\n            border-radius: 8px;\n            padding: 12px;\n            margin-bottom: 12px;\n          ">\n            <div style="font-size: 12px; font-weight: 600; margin-bottom: 6px; opacity: 0.9;">🌐 Target Website:</div>\n            <div style="font-size: 13px; font-weight: 500; color: #e8f4fd;">${n}</div>\n          </div>\n          \n          <div style="font-size: 11px; opacity: 0.8; text-align: center; font-style: italic;">\n            Navigate to the website and complete your task naturally\n          </div>\n        </div>\n      `,document.body.appendChild(e),this.taskOverlay=e}hideTaskOverlay(){const e=document.getElementById("unified-task-overlay");e&&e.remove(),this.taskOverlay=null}restoreTaskOverlay(){if(this.isTracking&&this.currentTask?(console.log("Unified: Restoring task overlay after navigation for task:",this.currentTask.title),setTimeout(()=>{},100)):this.isTracking&&!this.currentTask&&(console.log("Unified: Tracking active but no current task - attempting to fetch task"),setTimeout(()=>{},500)),this.isTracking&&this.currentTask&&this.currentTask.website){const e=window.location.hostname,t=new URL(this.currentTask.website).hostname;(e===t||e.includes(t))&&(console.log("Unified: Now on task target website!",e),this.showTaskCompletionHint())}}showTaskCompletionHint(){const e=document.getElementById("unified-task-completion-hint");e&&e.remove();const t=document.createElement("div");t.id="unified-task-completion-hint",t.innerHTML='\n        <div style="\n          position: fixed;\n          bottom: 20px;\n          right: 20px;\n          background: linear-gradient(135deg, #FF6B6B 0%, #4ECDC4 100%);\n          color: white;\n          padding: 16px 20px;\n          border-radius: 8px;\n          font-family: Arial, sans-serif;\n          font-size: 14px;\n          z-index: 999999;\n          box-shadow: 0 4px 12px rgba(0,0,0,0.3);\n          max-width: 300px;\n          animation: slideIn 0.3s ease-out;\n        ">\n          <div style="font-size: 18px; margin-bottom: 8px;">🎯 Task Website Reached!</div>\n          <div style="font-weight: bold; margin-bottom: 4px;">You\'re now on the target website</div>\n          <div style="font-size: 12px; opacity: 0.9;">Start completing your task objectives</div>\n        </div>\n        <style>\n          @keyframes slideIn {\n            from { transform: translateX(100%); opacity: 0; }\n            to { transform: translateX(0); opacity: 1; }\n          }\n        </style>\n      ',document.body.appendChild(t),setTimeout(()=>{t.parentNode&&t.remove()},4e3)}getStatus(){const e=this.events.length+(this.restoredEventCount||0),t=this.screenshots.length+(this.restoredScreenshotCount||0);return{isTracking:this.isTracking,sessionId:this.sessionId,startTime:this.startTime,duration:this.isTracking?Date.now()-this.startTime:0,eventCount:e,screenshotCount:t,currentUrl:window.location.href,qualityScore:this.calculateQualityScore(),completeness:this.calculateCompleteness(),currentTask:this.currentTask,taskProgress:this.taskProgress}}async getSessionData(){return this.isTracking?await this.prepareSessionData():null}updateConfig(e){this.config={...this.config,...e},console.log("Unified: Config updated:",e)}throttle(e,t){let n;return function(){const i=arguments;n||(e.apply(this,i),n=!0,setTimeout(()=>n=!1,t))}}generateId(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}setupStatePreservation(){const e=()=>{this.isTracking&&(console.log("Unified: Saving state before navigation"),this.saveState())};window.addEventListener("beforeunload",e),window.addEventListener("pagehide",e),this.statePreservationInterval&&clearInterval(this.statePreservationInterval),this.statePreservationInterval=setInterval(()=>{this.isTracking&&this.saveState()},5e3)}cleanupStatePreservation(){this.statePreservationInterval&&(clearInterval(this.statePreservationInterval),this.statePreservationInterval=null)}getPrunedDOMSnapshot(e){let t=e;for(let e=0;e<5&&t.parentElement;e++)t=t.parentElement;return this.serializeElementTree(t,5)}serializeElementTree(e,t){if(t<=0)return null;const n={tag:e.tagName.toLowerCase(),attributes:{},children:[]};for(const t of e.attributes)["id","class","data-testid","role","type"].includes(t.name)&&(n.attributes[t.name]=t.value);1===e.childNodes.length&&e.childNodes[0].nodeType===Node.TEXT_NODE&&(n.text=e.textContent.trim().substring(0,100));for(let i=0;i<Math.min(e.children.length,10);i++){const s=this.serializeElementTree(e.children[i],t-1);s&&n.children.push(s)}return n}generatePageHash(){const e=document.title+window.location.pathname+document.body.innerHTML.substring(0,1e3);let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n),t&=t;return`sha256-${Math.abs(t).toString(16)}`}getRecentNetworkRequests(){return[]}getElementAttributes(e){const t={};for(const n of e.attributes)t[n.name]=n.value;return t}generateCSSSelector(e){const t=[];let n=e;for(;n&&n!==document.body;){let e=n.tagName.toLowerCase();if(n.id){e+=`#${n.id}`,t.unshift(e);break}if(n.className){const t="string"==typeof n.className?n.className:n.className.baseVal||n.className.toString();if(t&&"string"==typeof t){const n=t.split(" ").filter(e=>e.trim());n.length>0&&(e+=`.${n.join(".")}`)}}const i=n.parentElement;if(i){const t=Array.from(i.children).filter(e=>e.tagName===n.tagName);t.length>1&&(e+=`:nth-child(${t.indexOf(n)+1})`)}t.unshift(e),n=n.parentElement}return t.join(" > ")}generateXPath(e){const t=[];let n=e;for(;n&&n!==document.documentElement;){let e=n.tagName.toLowerCase();if(n.id){e=`${e}[@id='${n.id}']`,t.unshift(e);break}const i=n.parentElement;if(i){const t=Array.from(i.children).filter(e=>e.tagName===n.tagName);t.length>1&&(e+=`[${t.indexOf(n)+1}]`)}t.unshift(e),n=n.parentElement}return"//"+t.join("/")}getElementBoundingBox(e){const t=e.getBoundingClientRect();return{x:Math.round(t.left),y:Math.round(t.top),width:Math.round(t.width),height:Math.round(t.height)}}getRelevantComputedStyle(e){const t=window.getComputedStyle(e);return{visibility:t.visibility,display:t.display,cursor:t.cursor,z_index:t.zIndex,position:t.position}}getParentElementInfo(e){const t=e.parentElement;if(!t)return null;const n="string"==typeof t.className?t.className:t.className.baseVal||t.className.toString();return{tag:t.tagName.toLowerCase(),classes:n?n.split(" ").filter(e=>e.trim()):[],id:t.id||null,css_selector:this.generateCSSSelector(t)}}getAncestorChain(e){const t=[];let n=e.parentElement;for(;n&&n!==document.body&&t.length<10;){const e="string"==typeof n.className?n.className:n.className.baseVal||n.className.toString();t.push({tag:n.tagName.toLowerCase(),classes:e?e.split(" ").filter(e=>e.trim()):[],id:n.id||null,css_selector:this.generateCSSSelector(n)}),n=n.parentElement}return t}getSiblingElements(e){const t=e.parentElement;if(!t)return[];const n=[],i=Array.from(t.children),s=i.indexOf(e);for(let e=Math.max(0,s-2);e<=Math.min(i.length-1,s+2);e++)if(e!==s){const t=i[e];n.push({position:e<s?"before":"after",tag:t.tagName.toLowerCase(),text:this.getElementText(t).substring(0,50),css_selector:this.generateCSSSelector(t)})}return n}findNearbyClickableElements(e,t=100){const n=[],i=e.getBoundingClientRect(),s=i.left+i.width/2,a=i.top+i.height/2;return document.querySelectorAll('a, button, input, select, textarea, [role="button"], [onclick], [tabindex]').forEach(i=>{if(i===e)return;const r=i.getBoundingClientRect();if(0===r.width||0===r.height)return;const o=r.left+r.width/2,l=r.top+r.height/2,c=Math.sqrt(Math.pow(o-s,2)+Math.pow(l-a,2));c<=t&&n.push({tag:i.tagName.toLowerCase(),text:this.getElementText(i).substring(0,50),css_selector:this.generateCSSSelector(i),distance:Math.round(c)})}),n.sort((e,t)=>e.distance-t.distance).slice(0,5)}detectActiveOverlays(){const e=[];return['.modal:not([style*="display: none"])','.overlay:not([style*="display: none"])','.popup:not([style*="display: none"])','.dialog:not([style*="display: none"])','[role="dialog"]:not([style*="display: none"])','.cookie-banner:not([style*="display: none"])','.cookie-consent:not([style*="display: none"])'].forEach(t=>{document.querySelectorAll(t).forEach(t=>{const n=window.getComputedStyle(t);if("none"!==n.display&&"hidden"!==n.visibility){const n=t.querySelector('button[class*="close"], .close, [aria-label*="close"]');e.push({id:t.id||`overlay-${e.length}`,css_selector:this.generateCSSSelector(t),bounding_box:this.getElementBoundingBox(t),close_button:n?{css_selector:this.generateCSSSelector(n)}:null})}})}),e}isElementInViewport(e){const t=e.getBoundingClientRect();return t.top>=0&&t.left>=0&&t.bottom<=window.innerHeight&&t.right<=window.innerWidth}testSelectorReliability(e){try{const t=document.querySelectorAll(e);return 1===t.length?1:Math.max(.1,1/t.length)}catch(e){return.1}}getViewportInfo(){return{width:window.innerWidth,height:window.innerHeight,scrollX:window.scrollX,scrollY:window.scrollY,devicePixelRatio:window.devicePixelRatio||1}}updateEvent(e){const t=this.events.findIndex(t=>t.id===e.id);-1!==t&&(this.events[t]={...this.events[t],...e},this.saveState(),chrome.runtime.sendMessage({action:"SEND_DATA",data:this.events[t]}))}getSessionData(){const e=this.isTracking?Date.now()-this.startTime:0,t={sessionId:this.sessionId,isTracking:this.isTracking,startTime:this.startTime,duration:e,currentUrl:window.location.href,events:this.events,eventCount:this.events.length,screenshots:this.screenshots,screenshotCount:this.screenshots.length,config:this.config,quality:this.calculateQualityScore(),pageContext:{title:document.title,url:window.location.href,timestamp:Date.now(),viewport:this.getViewportInfo(),userAgent:navigator.userAgent},dataStructure:{enhancedDataGroups:6,version:"2.0",features:["multi-selector-generation","enhanced-element-analysis","visual-context-collection","dom-hierarchy-mapping","state-change-detection","detailed-interaction-metadata"]}};return this.sanitizeData(t)}calculateQualityScore(){if(0===this.events.length)return 0;let e=0,t=0;return this.events.forEach(n=>{t++,n.selectors&&n.selectors.primary&&(e+=20),n.element&&n.element.tag&&(e+=20),n.visual&&n.visual.boundingBox&&(e+=20),n.context&&n.context.parentElements&&(e+=20),n.interaction&&n.interaction.coordinates&&(e+=20)}),t>0?Math.round(e/t):0}getStatus(){return{isTracking:this.isTracking,sessionId:this.sessionId,eventCount:this.events.length,screenshotCount:this.screenshots.length,duration:this.isTracking?Date.now()-this.startTime:0,quality:this.calculateQualityScore()}}},console.log("🚀 CodeSight Enhanced Tracker Loaded!",(new Date).toISOString()))}();
//# sourceMappingURL=content-script.js.map